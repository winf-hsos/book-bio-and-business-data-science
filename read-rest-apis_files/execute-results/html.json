{
  "hash": "c23dcdc741fb93d6b9a933854c0cc646",
  "result": {
    "markdown": "# Daten aus REST APIs\n\nNeben Dateien, wie CSV oder Excel-Formate, bieten gerade Softwareanwendungen in der Cloud häufig Webschnittstellen für den Zugriff auf ihre Daten an. Auch Shopify erlaubt den Zugriff auf sämtliche Daten mittels einer REST API. Der Begriff API steht für *Application Programming Interface* und bedeutet übersetzt *Programmierschnittstelle*. Was aber ist eine REST API?\n\n## Was ist REST?\n\nREST steht für **Representational State Transfer** und ist ein häufig verwendetes Protokoll für Programmierschnittstellen, die über Webprotokolle kommunizieren. Wir sprechen dann auch von *Webschnittstellen* oder *Webservices*.\n\n## REST-Aufrufe mit R\n\n### Einen HTTP-Request erstellen\n\nREST-Schnittstellen verwenden das HTTP-Protokoll für die Kommunikation zwischen Client und Server. Um HTTP-Aufrufe mit R zu erstellen und auszuführen, installieren wir das Paket `httr2`:\n\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-1_c8232a386bb1c7c92a2594435cda965c'}\n\n```{.r .cell-code}\ninstall.packages(\"httr2\")\ninstall.packages(\"jsonlite\")\n```\n:::\n\n\nAnschließend können wir die Funktion `request` verwenden, um einen HTTP-Aufruf mit einer URL auszuführen. Im Standard verwendet die Funktion die Operation `GET`:\n\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-2_d2d91680cf8454d98279ebcec9d32f37'}\n\n```{.r .cell-code}\nlibrary(httr2)\n\nurl <- \"https://hs-osnabrueck.de\"\nreq <- request(url)\nreq\n\n# <httr2_request>\n# GET https://hs-osnabrueck.de\n# Body: empty\n```\n:::\n\n\n::: {.callout-tip appearance=\"minimal\"}\n## Mehr über HTTP-Requests\n\nNeben `GET` kennt das HTTP-Protokoll auch andere Operationen. Einen Überblick findet ihr auf den Webseiten des [Mozilla Developer Networks](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods).\n:::\n\n### Einen HTTP-Request ausführen\n\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-3_e1f26186863dbd81bd3f3494e06ca477'}\n\n```{.r .cell-code}\nresp <- req_perform(req)\nresp\n\n# GET https://www.hs-osnabrueck.de/\n# Status: 200 OK\n# Content-Type: text/html\n# Body: In memory (72768 bytes)\n```\n:::\n\n\nDer [Status-Code](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status) 200 zeigt an, dass der Request erfolgreich war. Zusätzlich wird der Antworttyp im Feld *Content-Type* ausgegeben, der hier `text/html` ist. Für den Content Type gibt es eine [standardisierte Liste von Werten](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types), die auch MIME-Types genannt werden. Die Größe der Antwort, die wir vom Webserver erhalten haben, beträgt 72768 Bytes oder ca. 73 Kilobytes. Das ist somit die Größe des HTML-Dokuments für die [Startseite der Hochschule Osnabrück](https://www.hs-osnabrueck.de/).\n\nWir könnten jetzt den Body der Antwort auslesen und das HTML-Dokument mit R weiter verarbeiten. Wenngleich das Analysieren von Webinhalten spannend sein kann, ist es nicht Thema dieses Kapitels.\n\n## Die Shopify API\n\nZum Start lohnt es sich, in die Dokumentation der Shopify API zu schauen. Shopify bietet [mehrere Programmierschnittstellen](https://shopify.dev/api) für unterschiedliche Zwecke. Darunter ist etwa die [Storefront-API](https://shopify.dev/api/storefront), um eigene Oberflächen für einen Webshop zu erstellen. Die für uns relevante API ist die [Admin-API](https://shopify.dev/api/admin). Sie bietet vollen Zugriff auf die Daten eines Shops. Voraussetzung dafür ist, dass der Shop-Inhaber eine App angelegt und die Berechtigungen für den Zugriff auf relevante Daten, wie die Bestellungen, erteilt hat. Mit dieser App generiert Shopify eine Kombination aus API-Schlüssel (API Key) und Passwort. Beide Informationen werden für den Zugriff auf die API benötigt.\n\nDie allgemeine URL für einen Aufruf der REST Admin API sieht wie folgt aus:\n\n```\nhttps://{apikey}:{password}@{hostname}/admin/api/{version}/{resource}.json\n```\n\n### Beispielaufruf\n\nZuerst definieren wir die URL für den Aufruf:\n\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-4_de4f2e83db39ad0a3a1bfc94d591751c'}\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"https://e1b14daf3821a15edac451f0c99c22dc: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@haster-bier.myshopify.com/admin/api/2022-04/locations.json\"\n```\n:::\n:::\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-5_4b98d1bfb397ba2b89c5a526675b2050'}\n\n```{.r .cell-code}\nurl <- \"https://**:**@haster-bier.myshopify.com/admin/api/2022-04/locations.json\"\n```\n:::\n\n\nAnschließend verwenden wir die `request` Funktion, um einen `GET`-Request zu erzeugen und danach  mit `req_perform` auszuführen:\n\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-6_a3c828c23f30a3d8777856c40f564c30'}\n\n```{.r .cell-code}\nreq <- request(url)\nresp <- req_perform(req)\nresp\n\n# <httr2_response>\n# GET\n# https://**:**@haster-bier.myshopify.com/admin/api/2022-04/locations.json\n# Status: 200 OK\n# Content-Type: application/json\n# Body: In memory (3016 bytes)\n```\n:::\n\n## Der Body einer REST-Response\n\nDer interessante Teil der Antwort steckt im sogenannten *Body*, dessen Inhalt wir je nach MIME-Type mit definierten Funktionen `resp_body_*` auslesen können. Wir bedienen uns hier der einfachsten und agnostischen Variante und lesen den Body als Zeichenkette (String) aus:\n\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-7_b80960ac05534cca4763f26579a05d48'}\n\n```{.r .cell-code}\nlocations <- resp %>%\n  resp_body_string()\n\nlocations %>%\n  glimpse()\n\n# chr \"{\\\"locations\\\":[{\\\"id\\\":66635038954,\\\"name\\\":\\\"Abholaktion 17.12.2021 # (Haste)\\\",\\\"address1\\\":\\\"Oldenburger Land\"| __truncated__\n```\n:::\n\n\nWie schon durch den Content-Type angekündigt, handelt es sich bei der Antwort um einen JSON-formatierten Text.\n\n## JSON verarbeiten mit `jsonlite`\n\nUm JSON-formatierte Texte in eine nutzbare Datenstruktur umzuwandeln, verwenden wir das Paket `jsonlite`. Es bietet zahlreiche Funktionen für die Arbeit mit dem JSON-Format, darunter die Funktion `fromJSON`, die uns einen String im JSON-Format in eine Liste von Dataframes umwandelt. Anschließend können wir mit der `tibble` Funktion daraus einen Tibble erstellen, den wir dann noch mit `unnest` auftrennen müssen:\n\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-8_2ac1ebcfb8cf4826f781a8e500ad12f4'}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(jsonlite)\n\nlocations_tbl <- fromJSON(locations) %>% \n  tibble() %>% \n  unnest(cols = c(.))\n\n# Alle Spaltennamen ausgeben lassen\nlocations_tbl %>% \n  colnames()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"id\"                      \"name\"                   \n [3] \"address1\"                \"address2\"               \n [5] \"city\"                    \"zip\"                    \n [7] \"province\"                \"country\"                \n [9] \"phone\"                   \"created_at\"             \n[11] \"updated_at\"              \"country_code\"           \n[13] \"country_name\"            \"province_code\"          \n[15] \"legacy\"                  \"active\"                 \n[17] \"admin_graphql_api_id\"    \"localized_country_name\" \n[19] \"localized_province_name\"\n```\n:::\n:::\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-9_7d679e34aef3b8167fe5e8f56d2ba85c'}\n\n```{.r .cell-code}\nlocations_tbl %>% \n  select(name)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"name\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"Abholaktion 17.12.2021 (Haste)\"},{\"1\":\"Campus Lingen der Hochschule Osnabrück\"},{\"1\":\"Hafen Osnabrück\"},{\"1\":\"Mensa am Westerberg der Hochschule Osnabrück\"},{\"1\":\"Schmied im Hone der Hochschule Osnabrück\"},{\"1\":\"Zwischenzeit 3.0\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-10_7de2abeeb5fff44134edc5ea4ceaf965'}\n\n```{.r .cell-code}\nlocations_tbl\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"id\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"name\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"address1\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"address2\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"city\"],\"name\":[5],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"zip\"],\"name\":[6],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"province\"],\"name\":[7],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"country\"],\"name\":[8],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"phone\"],\"name\":[9],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"created_at\"],\"name\":[10],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"updated_at\"],\"name\":[11],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"country_code\"],\"name\":[12],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"country_name\"],\"name\":[13],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"province_code\"],\"name\":[14],\"type\":[\"lgl\"],\"align\":[\"right\"]},{\"label\":[\"legacy\"],\"name\":[15],\"type\":[\"lgl\"],\"align\":[\"right\"]},{\"label\":[\"active\"],\"name\":[16],\"type\":[\"lgl\"],\"align\":[\"right\"]},{\"label\":[\"admin_graphql_api_id\"],\"name\":[17],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"localized_country_name\"],\"name\":[18],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"localized_province_name\"],\"name\":[19],\"type\":[\"lgl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"66635038954\",\"2\":\"Abholaktion 17.12.2021 (Haste)\",\"3\":\"Oldenburger Landstraße 24\",\"4\":\"Einfahrt gegenüber vom Dehner Gartencenter\",\"5\":\"Osnabrück\",\"6\":\"49090\",\"7\":\"NA\",\"8\":\"DE\",\"9\":\"\",\"10\":\"2021-12-01T10:31:55+01:00\",\"11\":\"2022-04-04T13:38:15+02:00\",\"12\":\"DE\",\"13\":\"Germany\",\"14\":\"NA\",\"15\":\"FALSE\",\"16\":\"FALSE\",\"17\":\"gid://shopify/Location/66635038954\",\"18\":\"Germany\",\"19\":\"NA\"},{\"1\":\"64758808751\",\"2\":\"Campus Lingen der Hochschule Osnabrück\",\"3\":\"Kaiserstraße 10C\",\"4\":\"\",\"5\":\"Lingen\",\"6\":\"49809\",\"7\":\"NA\",\"8\":\"DE\",\"9\":\"\",\"10\":\"2021-08-16T14:10:09+02:00\",\"11\":\"2022-04-04T13:21:51+02:00\",\"12\":\"DE\",\"13\":\"Germany\",\"14\":\"NA\",\"15\":\"FALSE\",\"16\":\"FALSE\",\"17\":\"gid://shopify/Location/64758808751\",\"18\":\"Germany\",\"19\":\"NA\"},{\"1\":\"69418352908\",\"2\":\"Hafen Osnabrück\",\"3\":\"Am Speicher\",\"4\":\"\",\"5\":\"Osnabrück\",\"6\":\"49090\",\"7\":\"NA\",\"8\":\"DE\",\"9\":\"\",\"10\":\"2022-06-21T09:31:06+02:00\",\"11\":\"2022-06-27T11:53:11+02:00\",\"12\":\"DE\",\"13\":\"Germany\",\"14\":\"NA\",\"15\":\"FALSE\",\"16\":\"TRUE\",\"17\":\"gid://shopify/Location/69418352908\",\"18\":\"Germany\",\"19\":\"NA\"},{\"1\":\"64758743215\",\"2\":\"Mensa am Westerberg der Hochschule Osnabrück\",\"3\":\"Barbarastraße 20\",\"4\":\"\",\"5\":\"Osnabrück\",\"6\":\"49076\",\"7\":\"NA\",\"8\":\"DE\",\"9\":\"\",\"10\":\"2021-08-16T14:08:37+02:00\",\"11\":\"2021-09-14T15:29:57+02:00\",\"12\":\"DE\",\"13\":\"Germany\",\"14\":\"NA\",\"15\":\"FALSE\",\"16\":\"TRUE\",\"17\":\"gid://shopify/Location/64758743215\",\"18\":\"Germany\",\"19\":\"NA\"},{\"1\":\"21467988047\",\"2\":\"Schmied im Hone der Hochschule Osnabrück\",\"3\":\"Oldenburger Landstraße 62\",\"4\":\"\",\"5\":\"Osnabrück\",\"6\":\"49090\",\"7\":\"\",\"8\":\"DE\",\"9\":\"+49495419695313\",\"10\":\"2019-03-21T16:46:32+01:00\",\"11\":\"2022-06-21T10:02:07+02:00\",\"12\":\"DE\",\"13\":\"Germany\",\"14\":\"NA\",\"15\":\"FALSE\",\"16\":\"FALSE\",\"17\":\"gid://shopify/Location/21467988047\",\"18\":\"Germany\",\"19\":\"NA\"},{\"1\":\"36770447439\",\"2\":\"Zwischenzeit 3.0\",\"3\":\"Große Hamkenstraße 31\",\"4\":\"\",\"5\":\"Osnabrück\",\"6\":\"49074\",\"7\":\"\",\"8\":\"DE\",\"9\":\"\",\"10\":\"2020-09-16T23:33:16+02:00\",\"11\":\"2021-08-16T14:05:37+02:00\",\"12\":\"DE\",\"13\":\"Germany\",\"14\":\"NA\",\"15\":\"FALSE\",\"16\":\"FALSE\",\"17\":\"gid://shopify/Location/36770447439\",\"18\":\"Germany\",\"19\":\"NA\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n## Bestellungen abfragen\n\nDa es in diesem Anwendungsfall um Verkaufsanalysen geht, interessieren uns speziell die Bestellungen, die Kunden in unserem Shop getätigt haben. Auch diese können wir über die Admin-API abrufen. Die URL von oben ändern wir [gemäß der Dokumentation](https://shopify.dev/api/admin-rest/2022-07/resources/order) ab:\n\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-11_edf040c1cdcb0aeb8d896c90f70f1301'}\n\n:::\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-12_d7c34415390a2a5a52644fe34eaf9d45'}\n\n```{.r .cell-code}\nurl <- \"https://**:**@haster-bier.myshopify.com/admin/api/2022-04/orders.json\"\n```\n:::\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-13_58e796eca0b2e2debd6fb78327c65563'}\n\n:::\n\n\nWenn wir nun den Request mit der neuen URL ausführen, erhalten wir als Ergebnis alle Bestellungen mit insgesamt 37 Zeilen und 85 Spalten:  \n\n\n::: {.cell hash='read-rest-apis_cache/html/unnamed-chunk-14_db2c1e70e291c5a7e31a3e1b8fe96612'}\n\n```{.r .cell-code}\nreq <- request(url)\nresp <- req_perform(req)\n\norders <- resp %>% \n  resp_body_string() %>% \n  fromJSON() %>% \n  tibble() %>% \n  unnest(cols = c(.)) %>% \n  dim()\n\norders\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 37 85\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}